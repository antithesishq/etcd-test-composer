name: Build Config + Workload Image; push to Antithesis; Validate SUT runs locally; kick off test

on:
  push:
    branches:
      - gh-action-docker-compose-up  # Trigger this action on push to the main branch
  workflow_dispatch:
    inputs:
      client_container:
        description: 'Container that emits "setup_complete" and has Test Composer drivers/commands'
        required: false
        default: 'client'
        type: string
      test:
        description: 'Test name'
        required: false
        default: 'etcd demo'
        type: string
      config_image:
        description: 'Config image'
        required: true
        default: us-central1-docker.pkg.dev/molten-verve-216720/demo-repository/etcd-config:latest
        type: string
      images:
        description: 'System images (separate with ;)'
        required: true
        default: us-central1-docker.pkg.dev/molten-verve-216720/demo-repository/etcd-client:latest;docker.io/bitnami/etcd:3.5
        type: string
      duration:
        description: 'Duration (exploration hours)'
        required: true
        type: int
        default: 0.5
      description:
        description: 'Test run description (avoid quotes, please!)'
        required: true
        type: string
        default: "[user] please provide description"
      email:
        description: 'Additional email notification recipient (separate with ;)'
        required: true
        type: string
        default: ""
  
env:
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: molten-verve-216720/demo-repository
  DOCKER_COMPOSE_PATH: "config/docker-compose.yml"  # path to docker compose in repository

jobs:
  build-push-validate-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the code
      uses: actions/checkout@v3

    - name: Login to Antithesis Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: _json_key
        password: ${{ secrets.JSON_LOGIN_KEY }}

    - name: Build and push config image
      uses: docker/build-push-action@v5
      with:
        context: ./config
        file: ./config/Dockerfile.config
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.REPOSITORY}}/etcd-config:latest,
          ${{ env.REGISTRY }}/${{ env.REPOSITORY}}/etcd-config:${{ github.sha }}

    - name: Build and push client image
      uses: docker/build-push-action@v5
      with:
        context: ./test-template
        file: ./test-template/Dockerfile.client
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.REPOSITORY}}/etcd-client:latest,
          ${{ env.REGISTRY }}/${{ env.REPOSITORY}}/etcd-client:${{ github.sha }}

    - name: Install Docker using Docker's official script
      run: |
            curl -fsSL https://get.docker.com -o get-docker.sh 
            sudo sh get-docker.sh
      continue-on-error: false

    - name: Install Docker Compose
      run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.3.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version
      continue-on-error: false

    - name: Start application-specific services using Docker Compose
      run: docker-compose -f $DOCKER_COMPOSE_PATH up -d
      continue-on-error: false

    - name: Sleep until setup_complete
      run: |
          docker exec -entrypoint $(docker ps | grep ${{ inputs.client_container || 'client' }} | awk '{print $1;}') bash -c 'i=0   
          while [ $i -lt 10 ];   
          do   
            if grep -q "antithesis_setup_FAKE" $ANTITHESIS_SDK_LOCAL_OUTPUT; then   
              echo "Setup_complete found"   
              break   
              exit 0
            fi   
              echo "Setup_complete not yet found"   
          sleep 10   
          i=$((i + 1))   
          done
          exit 1'
      continue-on-error: false 

    - name: Confirm Test Composer driver/commands run properly
      run: |
          docker exec -entrypoint $(docker ps | grep ${{ inputs.client_container || 'client' }} | awk '{print $1;}') bash -c '
          set -e
          ORDER=(first_ singleton_ serial_ parallel_ anytime_ eventually_ finally_)
          TOP_DIR="/opt/antithesis/test/v1/"
          for prefix in "${ORDER[@]}"; do
            mapfile -d "" files < <(find "$TOP_DIR" -type f -executable -name "${prefix}*" -print0)
            for file in "${files[@]}"; do
              echo "Running $file"
              "$file" > /dev/null 2>&1
              echo "$file completed successfully!"
            done
          done'
      continue-on-error: false 

    # Run Antithesis Tests
    - name: Run Antithesis Tests
      uses: antithesishq/antithesis-trigger-action@main
      with:
        notebook_name: etcd
        tenant: demo
        username: ${{ secrets.ANTITHESIS_USERNAME }}
        password: ${{ secrets.ANTITHESIS_PASSWORD }}
        github_token: ${{ secrets.GH_PAT }}
        config_image: ${{ inputs.config_image || 'us-central1-docker.pkg.dev/molten-verve-216720/demo-repository/etcd-config:latest' }}
        images: ${{ inputs.images || 'us-central1-docker.pkg.dev/molten-verve-216720/demo-repository/etcd-client:latest;docker.io/bitnami/etcd:3.5' }}
        description: ${{ inputs.description || 'automatic run' }}
        email_recipients: ${{ inputs.email || ''}}
        test_name: ${{ inputs.test || 'automatic run'}}
        additional_parameters: |-
          custom.duration = ${{ inputs.duration || 0.5 }}